

## 1. 映画特定「共同捜査型アキネーター」実装指示書

オヤデキの既存スタック（LINE Bot + Supabase + Gemini API）を前提とした、エンジニア向けの機能要件定義です。

### 【機能概要】

ユーザーが送信した映画のワンカットから、AIが「視覚的特徴」を元に質問を投げ、ユーザーと対話しながら作品を特定するゲーム。

### 【技術スタック】

* **LLM:** Gemini 1.5 Flash (高速・安価) または 1.5 Pro
* **Database:** Supabase (セッション管理用)
* **API:** LINE Messaging API, Gemini API (with Google Search Grounding)

### 【実装フロー】

1. **画像受信 & 初期解析**:
* ユーザーが画像を送信。
* Geminiに画像を投げ、`Google Search` ツールを併用して作品名を**内部的に**特定。
* Supabaseの `sessions` テーブルに `user_id` をキーとして「正解の作品名」「現在の質問数」「抽出した特徴」を保存。


2. **対話ループ**:
* AIは正解を伏せ、画像から読み取れる「視覚的特徴（俳優、照明、服装など）」に基づき、Yes/Noで答えられる質問を1つ生成。
* ユーザーの回答をDBの履歴に追加し、Geminiに「これまでの履歴＋正解」を渡して次の質問を生成。


3. **正解判定**:
* 確信度が閾値を超えた、または規定回数（例：10問）に達したら正解を提示。



### 【エンジニアへの共有用テキスト】

> **映画特定Bot 実装依頼メモ**
> **1. Gemini API設定:**
> * `model`: `gemini-1.5-flash`
> * `tools`: `[{ "google_search": {} }]` (画像だけでは特定困難なケースがあるため必須)
> * `system_instruction`: 「映画マニアの探偵」として振る舞う。画像から正解を推測しつつも、最初は隠し、視覚的ヒント（色味、構図、俳優の年齢等）から質問攻めにしてユーザーに正解を言わせるか、最後に当てる。
> 
> 
> **2. Supabase DB設計:**
> * `game_sessions` テーブル作成
> * `user_id` (primary key)
> * `status` (guessing / finished)
> * `internal_answer` (AIが最初に特定した作品名)
> * `visual_clues` (画像から抽出したメタデータ/JSON)
> * `chat_history` (context保持用)
> 
> 
> 
> 
> **3. ロジック:**
> * 画像を受信したら `generativeModel.generateContent` で画像解析＋検索。
> * 回答は常に「1つの質問」で終わるように制約をかける。
> * ユーザーが「わからない」と言った場合のフォローアップ処理を組み込む。
> 
> 

---

## 2. メルカリ出品・相場調査ツール（プロンプト＆仕組み）

メルカリ用には、**「画像1枚から商品説明・カテゴリ・ハッシュタグ・相場を一度に生成する」** 仕組みが最も効率的です。

### 【Geminiへの入力プロンプト例】

これをGemini（またはBotのバックエンド）に投げれば、出品準備が5秒で終わります。

> **役割:** メルカリのプロ出品者
> **入力:** 商品画像
> **タスク:**
> 1. **商品特定:** 画像からブランド、モデル名、型番を特定する。
> 2. **相場調査:** `Google Search` を使い、現在のメルカリでの「売り切れ（Sold）」価格帯をリサーチし、おすすめの販売価格（送料込み）を提示する。
> 3. **文章作成:** 以下の項目で出品文を作成する。
> * タイトル（検索されやすいキーワードを含む）
> * 商品説明（状態、購入時期、出品理由をテンプレート化）
> * カテゴリ、ハッシュタグ（5個）
> 
> 
> 4. **注意点:** 傷や汚れがあるように見える場合は、その旨を正直に記載する項目を設ける。
> 
> 

### 【実装のポイント】

* **相場調査の自動化**: `Google Search` ツールを使い、`site:jp.mercari.com "商品名" "売り切れ"` で検索した結果を要約させるのが最も正確です。
* **出品テンプレートのカスタマイズ**: デラさんの好みの配送方法（らくらくメルカリ便等）をあらかじめシステムプロンプトに入れておけば、送料計算まで含めたアドバイスが可能です。


## 3. 推奨モデル（2026年2月現在）

**推奨: `gemini-2.5-flash`**

*   **現状の最適解**: 1.5系と比較して「速度」と「認識精度」のバランスが最も良く、コストパフォーマンスも高いため、本プロジェクトの標準モデルとして採用します。
*   **コードベース設定**: `gemini-client.ts` 内では既に `gemini-2.5-flash` をデフォルトとして設定済みです。
*   **使い分け基準**:
    *   **基本（画像解析・チャット・JSON抽出）**: `gemini-2.5-flash` (推奨)
    *   **高負荷な推論（複雑な長文読解など）**: `gemini-2.5-pro` (必要に応じて)
*   **注意点**: Web上の古い情報やブラウザ版Geminiでは `1.5 Flash` が提案されることがありますが、API利用時は迷わず `2.5` 系を指定してください。

