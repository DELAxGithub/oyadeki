# オヤデキ ロードマップ (v2026-01-17 改訂版)

## 1. 目的・KGI
*   **KGI**: 親の「デジタル詰み」を最短3手順で解消し、家族の摩擦を減らす。
*   **副目標**: 解約・連絡先の「地図」（契約台帳）を家族と共有し、終活の初期摩擦を下げる。

## 2. スコープ
### In (やる)
*   **W4.5**: Rich Menu & Personality (Zweigenトーン / 静かなBot運用) - **W4.5コード完了済**
*   **W4**: デジタル救急箱 (Vision → 3手順 + 通話誘導) - **W4コード完了済**
*   **W5**: 契約台帳 (Ledger) (生パスワード非保持 / ID・金額・解約メモ / グループ要約共有) - **W5完了済**
*   **W6**: メディアログ (写真→メディア識別→評価→記録 / 「見た」コマンドで履歴表示) - **W6完了済**
*   **W6.5**: 出品サポート (「売る」→商品写真→タイトル・説明文生成) - **W6.5完了済**

### Out (やらない / 廃止)
*   パスワード保管・自動入力
*   視聴履歴の自動収集
*   メルカリ相場推定/自動出品
*   ダッシュボード大画面UI
*   健康・位置情報
*   ~~下書き提案~~ (W6でメディアログに置き換え)

## 3. 体制・運用
*   **ルーム運用**: 親・子・Botの同室。Botは画像 or 呼びかけ時のみ発話。
*   **役割**: Viewer(親), Custodian(子), Emergency(一時鍵)
*   **トーン**: Zweigen比喩は「lite」が既定（濃さ可変）。

## 4. 非機能要件
*   **レイテンシ**: Vision応答 p95 ≤ 3.0s (画像〜返信)
*   **信頼性**: Gemini障害時は定型の安全退避メッセージ
*   **セキュリティ**: LINE署名検証必須 / RLS厳格 / ログPIIマスキング / 画像既定非保存
*   **プライバシー**: グループには要約のみ、詳細はDMリンク (監査ログ記録)

## 5. KPI (成功指標)
*   **救急箱**: 再発行導線 → 完了率 ≥ 80%, JSON検証エラー < 1%
*   **契約台帳**: 初週登録 ≥ 5件, 半年更新率 ≥ 70%
*   **メディアログ**: 月間記録数 ≥ 10件, 評価率 ≥ 60%

---

## 📅 ロードマップ (2026-01-17 〜 02-07)

### ✅ フェーズ0: W4.5 “運用完了” (1/17–1/19)
> ゲート: メニューから4機能に到達でき、初回チュートリアルが配信できる。

| タスク | 状態 | 備考 |
|--------|------|------|
| Rich Menu画像作成 (赤・黒・金) | ✅ | 実装・生成完了 |
| LINE OA Manager設置 & リンク設定 | 🔲 | 手動作業 (下記参照) |
| チュートリアル文面確認 ("使い方") | ✅ | 実装済み |
| グループ静音確認 | 🔲 | 実機確認 |
| プロンプト魂入れ (Zweigen Soul) | ✅ | 実装・デプロイ済み |

### 📁 フェーズ1: W4 救急箱 v1.1 完了 (1/20–1/25)
> ゲート: 5ケースすべてグリーン / KPIが取得できる。

- [ ] 受け入れテスト (5ケース)
    1. パスワード忘れ画面 → 3手順＋通話誘導 ✅
    2. SMSコード未着 → 原因切り分け＋通話誘導 ✅
    3. アプリ更新ダイアログ → ストア遷移案内 ✅
    4. 決済系の警告 → 「赤紙＝危険」メタファで中止提案 ✅
    5. 不明スクショ → 安全退避ルート ✅
- [x] エラーハンドリング (Gemini失敗時の定型返答)
- [x] KPIダッシュ (軽): 応答時間、検証エラー、👍率

### ✅ フェーズ2: W5 契約台帳 v1.0 (1/26–1/31)
> ゲート: 親の台帳5件作成 / PDFを子が閲覧可能。

- [x] 登録フロー: スクショ/URL → 候補提案 → 2タップ保存 (生PWなし) - **実装済**
- [x] 共有機能: グループ要約 + 詳細DMリンク (30日期限) - **実装済 2026-01-26**
  - `ledger_shares`テーブル追加
  - `/share/[token]` LIFFページ追加
  - グループ要約メッセージ生成
- [x] 棚卸し機能: 登録5件で週報に「未確認あり」表示 - **実装済 2026-01-26**
  - `unconfirmed_ledgers`ビュー追加
  - `weekly-ledger-report` Edge Function追加
  - 未確認バッジ表示（7日以上未確認）
- [x] エクスポート: CSV ("鍵は含まない"注意書き) - **実装済 2026-01-26**
  - PDF対応は今後検討

**✅ デプロイ完了**: 2026-01-26
- Supabase Edge Functions: `oyadeki-webhook`, `weekly-ledger-report`
- LIFF: https://oyadeki-liff.deno.dev
- 共有ページ: https://oyadeki-liff.deno.dev/share/{token}
- ユーザーガイド: [`docs/USER_GUIDE.md`](docs/USER_GUIDE.md)

### ✅ フェーズ3: W6 メディアログ v1.0 (1/27)
> ゲート: 写真送信 → メディア識別 → 評価保存 → 履歴表示が動作する。

- [x] 画像Intent判定: help(操作困り) / media(視聴中) の自動分岐 - **実装済 2026-01-27**
- [x] メディア識別: 映画・TV・スポーツ・音楽・本を自動認識 - **実装済 2026-01-27**
- [x] 評価保存: ⭐1〜5で記録、DBに保存 - **実装済 2026-01-27**
- [x] 履歴表示: 「見た」コマンドでカルーセル表示 - **実装済 2026-01-27**
- [x] 下書き提案機能: 廃止（メディアログに置き換え）

**✅ デプロイ完了**: 2026-01-27
- `media_logs` テーブル追加
- Gemini Vision で画像Intent判定・メディア識別

### ✅ フェーズ3.5: 出品サポート & UX改善 (1/27)
> ゲート: 「売る」→写真→出品文が生成される

- [x] スクショ撮影方法をヘルプに追加 - **実装済 2026-01-27**
- [x] 「売る」「出品」コマンド → 出品モード開始 - **実装済 2026-01-27**
- [x] 商品写真 → タイトル・説明文・カテゴリ・状態を生成 - **実装済 2026-01-27**
- [x] 5分間の出品モードタイムアウト

**✅ デプロイ完了**: 2026-01-27

### ✅ フェーズ4: UI刷新 & デザイン適用 (1/28)
>ゲート: Pencilデザインシステムによる統一感のあるUI/UX。

- [x] デザインシステム定義: Pencil (`oyadeki.pen`) 作成 - **完了**
- [x] LIFF刷新: 設定画面・シェア画面のカードUI化 - **完了**
- [x] Flex Message刷新: Green & Gold配色、警告色調整 - **完了**
- [x] 全体デプロイ: Supabase & Deno Deploy - **完了**

### 🚀 フェーズ5: 初期設定 & ソフトローンチ (2/1〜)
> ゲート: 本番環境での動作確認 → 家族への展開。

- [ ] **初期設定 (Secrets & Webhook)**: ← **イマココ**
- [ ] 動作確認 (自分のみ): 全機能を実機でテスト
- [ ] ソフトローンチ: 家族1名を招待して1週間運用
- [ ] 本番運用開始

---

## 🛠️ 初期設定ガイド (Setup Guide)

本番運用を開始するためのステップです。

### 1. 環境変数の設定 (Supabase Secrets)
以下のコマンドを実行して、本番環境にAPIキーなどを設定してください。

```bash
npx supabase secrets set \
  LINE_CHANNEL_ACCESS_TOKEN="あなたのチャンネルアクセストークン" \
  LINE_CHANNEL_SECRET="あなたのチャンネルシークレット" \
  GEMINI_API_KEY="AIのAPIキー"
```

### 2. LINE Developers設定
LINE Developersコンソールにて以下を設定してください。

*   **Webhook URL**:
    `https://xnzlfpzecupaoilinddx.supabase.co/functions/v1/oyadeki-webhook`
    *   "Use webhook" をONにする。
*   **LIFF Endpoint URL**:
    `https://oyadeki.deno.dev` (または実際のDeno Deploy URL)

### 3. 本番運用のタイミング
以下のステップでの段階的リリースを推奨します。

1.  **Developer Test (即日)**:
    *   設定後、すぐに自分のLINEアカウントで「使い方の確認」「画像の投稿」などを試す。
2.  **Soft Launch (週末)**:
    *   家族1人（信頼できる相手）とグループを作り、招待する。
    *   1週間ほど運用し、Botの反応速度や誤爆がないか確認。
3.  **Grand Open**:
    *   問題なければ他の家族も招待。

---

## 環境情報

### Supabase
- Project: `xnzlfpzecupaoilinddx`
- Dashboard: https://supabase.com/dashboard/project/xnzlfpzecupaoilinddx

### LINE
- LIFF ID: `2008909268-tE6zSm0T`
- Webhook URL: `https://xnzlfpzecupaoilinddx.supabase.co/functions/v1/oyadeki-webhook`

### Deno Deploy (LIFF)
- URL: https://oyadeki.deno.dev (要確認)

---

*最終更新: 2026-01-28 (v6 - デザイン適用・初期設定ガイド追加)*
